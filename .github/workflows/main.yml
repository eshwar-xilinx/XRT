name: Test Action

on:     
  pull_request:

jobs:
#  vm_creation:
#    runs-on: p_pipeline
#    steps:
#    - name: refreshing vm
#      run: |
#          echo "Reverting the machine back to original state"
#          virsh shutdown vm_name
#          virsh snapshot-revert  --domain ubuntu18.04 --snapshotname ubuntu_snapshot --running

  main:
#    needs: vm_creation
    runs-on: pr_pipeline
    steps:
    - name: Creating environmental variables
      run: |
         echo "$GITHUB_REF"
         PR_NUMBER=$(echo $GITHUB_REF | awk 'BEGIN { FS = "/" } ; { print $3 }')
         echo "$PR_NUMBER generated by GITHUB_REF env"
         echo "${{github.event.pull_request.number}} generated by github action event"
         
    - name: Changing to working directory and removing preexisted XRt folder
      run: |
          cd 
          rm -rf XRT/
          echo "$(ls) are the files present"
          
    - name: Cloning XRT
      run: |
         echo "$(readlink -f .)"
         git clone "https://github.com/eshwar-xilinx/XRT.git"
         
    - name: Changing directory
      run: |
         echo "$(readlink -f .)"
         cd XRT
        
    - name: Fetching to PR branch
      run: |
         git fetch origin pull/${{github.event.pull_request.number}}/head:master1
    
    - name: Checkout PR branch
      run: |
         git checkout master1
        
    - name: Running XRT deps for dependencies
      run: |
          DIR_PATH=$(readlink -f .)
          sudo $DIR_PATH/src/runtime_src/tools/scripts/xrtdeps.sh
          
    - name: Building deb/rpm
      run: |
          DIR_PATH=$(readlink -f .)
          sudo $DIR_PATH/build/build.sh                     
